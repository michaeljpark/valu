<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Details - Valu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <style>
        .journey-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px 40px 20px;
        }

        .journey-hero {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
        }

        .journey-hero-image-container {
            background: white;
            border-radius: 24px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            height: 100%;
            position: relative;
        }

        .journey-hero-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .journey-hero-content {
            background: white;
            padding: 32px;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            width: 100%;
            aspect-ratio: 1 / 1;
            display: flex;
            flex-direction: column;
        }

        .analysis-title {
            font-size: 24px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .analysis-text {
            font-size: 16px;
            line-height: 1.8;
            color: #374151;
        }

        .analysis-meta {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid #E5E7EB;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }

        .meta-item h4 {
            font-size: 14px;
            color: #6B7280;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .meta-item p {
            font-size: 18px;
            color: #111827;
            font-weight: 600;
        }

        .seller-info {
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #E5E7EB;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .seller-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: #F3F4F6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #6B7280;
        }

        .seller-details h4 {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }

        .seller-details p {
            font-size: 13px;
            color: #6B7280;
        }

        @media (max-width: 768px) {
            .journey-container {
                padding: 20px 16px;
            }
            
            .journey-hero {
                grid-template-columns: 1fr !important;
                gap: 24px;
                margin-top: 24px;
            }

            .journey-hero-image-container {
                min-height: 300px;
                border-radius: 16px;
            }

            .journey-hero-content {
                padding: 24px;
                border-radius: 16px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <a href="home.html" class="logo">
                <picture>
                    <source media="(max-width: 768px)" srcset="valuapp.svg">
                    <img src="valuweb.svg" alt="Valu">
                </picture>
            </a>
            <div class="nav-actions">
                <div class="nav-switch">
                    <a href="marketplace.html" class="btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-grid-icon lucide-layout-grid"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg> My Feed
                    </a>
                    <a href="index.html" class="btn">
                        <i class="fa-regular fa-user"></i> My Value
                    </a>
                </div>
                <a href="post.html" class="btn btn-primary">
                    <i class="fa-solid fa-plus"></i> Post Asset
                </a>
            </div>
        </header>

        <!-- Listing Content -->
        <div class="journey-container">
            <h1 class="search-keyword" id="listing-title" style="margin-bottom: 8px;"></h1>
            <div class="listing-meta" style="display: flex; align-items: center; gap: 8px; color: #6B7280; font-size: 13px; margin-bottom: 24px;">
                <span id="post-time"></span>
                <span>·</span>
                <span id="post-chats"></span>
                <span>·</span>
                <span id="post-likes"></span>
                <span>·</span>
                <span id="post-views"></span>
            </div>

            <div id="journey-hero" class="journey-hero">
                <div class="journey-hero-image-container" style="background-color: #F3F4F6; display: flex; align-items: center; justify-content: center;">
                    <div id="listing-like-btn" class="listing-like-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"/></svg>
                    </div>
                    <img src="valu text.svg" alt="Placeholder" style="width: 120px; height: auto; opacity: 0.4; filter: grayscale(100%);">
                    <img id="listing-image" src="" alt="Listing Image" class="journey-hero-image" style="display: none;">
                </div>
                <div class="journey-right-column" style="display: flex; flex-direction: column; gap: 24px;">
                    <div class="seller-comment-card" style="background: white; padding: 32px; border-radius: 24px; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; gap: 24px;">
                        <div id="seller-comment" class="comment-text" style="font-size: 15px; color: #374151; line-height: 1.6; word-break: break-word;">
                            Loading comment...
                        </div>
                        <button class="contact-btn" style="background: #000; color: white; padding: 10px 28px; border-radius: 100px; font-weight: 500; font-size: 15px; white-space: nowrap; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-icon lucide-send"><path d="M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z"/><path d="m21.854 2.147-10.94 10.939"/></svg> contact
                        </button>
                    </div>
                    <div class="journey-hero-content" style="aspect-ratio: auto;">
                        <div class="analysis-title" style="margin-bottom: 16px;">
                        Market Analysis
                    </div>
                    <div id="ai-text" class="analysis-text" style="font-size: 15px; line-height: 1.6;">
                        <i class="fa-solid fa-spinner fa-spin"></i> Analyzing market data...
                    </div>
                    
                    <div class="analysis-meta" style="margin-top: 20px; padding-top: 16px; gap: 16px;">
                        <div class="meta-item">
                            <h4 style="margin-bottom: 4px;">Origin</h4>
                            <p id="ai-origin" style="font-size: 16px;">-</p>
                        </div>
                        <div class="meta-item">
                            <h4 style="margin-bottom: 4px;">Est. Price</h4>
                            <p id="ai-price" style="font-size: 16px;">-</p>
                        </div>
                    </div>

                    <div id="price-chart-container" style="margin-top: 20px; flex: 1; width: 100%; min-height: 0;"></div>

                    <!-- Seller Info -->
                    <div class="seller-info">
                        <div class="seller-avatar">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <div class="seller-details">
                            <h4 id="seller-name">Loading...</h4>
                            <p id="seller-location"><i class="fa-solid fa-location-dot"></i> Downtown Toronto, ON</p>
                        </div>
                        <div style="margin-left: auto; text-align: right;">
                            <div style="font-size: 12px; color: #6B7280;">Listing Price</div>
                            <div id="listing-price" style="font-size: 20px; font-weight: 700; color: #111827;">-</div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Recommended Listings -->
        <div class="recommendations-section" style="margin-top: 80px; padding-top: 40px; border-top: 1px solid #E5E7EB;">
            <h2 style="font-size: 20px; font-weight: 700; margin-bottom: 24px;">You might also like</h2>
            <div class="marketplace-grid" id="recommended-grid" style="grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));">
                <!-- Items injected by JS -->
            </div>
        </div>
    </div>

    <script>
        // Get params from URL
        const urlParams = new URLSearchParams(window.location.search);
        const title = urlParams.get('title') || 'Item Details';
        const price = urlParams.get('price') || '0';
        const est = urlParams.get('est') || '0';
        // const img = urlParams.get('img') || ''; // Image is no longer used
        
        // Set basic info
        document.getElementById('listing-title').textContent = title;
        // document.getElementById('listing-image').src = img; // Don't load external images
        document.getElementById('listing-price').textContent = '$' + parseInt(price).toLocaleString();
        document.getElementById('ai-price').textContent = '$' + parseInt(est).toLocaleString();

        // Random Seller Info
        const sellers = ['Alex M.', 'Sarah K.', 'David R.', 'Jessica W.', 'Michael B.', 'Emily T.'];
        const streets = ['King St W', 'Queen St W', 'Spadina Ave', 'Yonge St', 'Bay St', 'Front St'];
        const randomSeller = sellers[Math.floor(Math.random() * sellers.length)];
        const randomStreet = streets[Math.floor(Math.random() * streets.length)];
        const randomNum = Math.floor(Math.random() * 900) + 100;
        
        document.getElementById('seller-name').textContent = randomSeller;
        document.getElementById('seller-location').innerHTML = `<i class="fa-solid fa-location-dot"></i> ${randomNum} ${randomStreet}, Toronto`;

        // Random Seller Comment
        const comments = [
            "Selling my ${title}. It's in excellent condition and I've only used it a few times. Comes with original packaging.",
            "Great deal on this ${title}! Well maintained and fully functional. Price is negotiable for quick sale.",
            "I'm upgrading so I need to sell my ${title}. Works perfectly, no scratches or issues. DM for more info.",
            "Barely used ${title}. Like new condition. Can meet in downtown Toronto for pickup.",
            "Got this ${title} as a gift but don't need it. Brand new, never opened. Message me if interested!"
        ];
        const randomComment = comments[Math.floor(Math.random() * comments.length)].replace('${title}', title);
        document.getElementById('seller-comment').textContent = randomComment;

        // Random Stats Generation
        const chats = Math.floor(Math.random() * 5);
        const likes = Math.floor(Math.random() * 30);
        const views = Math.floor(Math.random() * 300) + 50;
        
        // Random Time (max 5 weeks)
        const maxTime = 5 * 7 * 24 * 60 * 60 * 1000; // 5 weeks in ms
        const randomTime = Math.floor(Math.random() * maxTime);
        
        let timeString = '';
        const minutes = Math.floor(randomTime / 60000);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const weeks = Math.floor(days / 7);

        if (weeks > 0) timeString = `${weeks} week${weeks > 1 ? 's' : ''} ago`;
        else if (days > 0) timeString = `${days} day${days > 1 ? 's' : ''} ago`;
        else if (hours > 0) timeString = `${hours} hour${hours > 1 ? 's' : ''} ago`;
        else timeString = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;

        document.getElementById('post-time').textContent = timeString;
        document.getElementById('post-chats').textContent = `Chat ${chats}`;
        document.getElementById('post-likes').textContent = `Interest ${likes}`;
        document.getElementById('post-views').textContent = `Views ${views}`;

        // Render D3 Price Chart
        function renderPriceChart(data) {
            const container = document.getElementById('price-chart-container');
            container.innerHTML = ''; 
            
            const margin = {top: 20, right: 20, bottom: 30, left: 50};
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;

            const svg = d3.select("#price-chart-container")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleLinear()
                .domain(d3.extent(data, d => d.year))
                .range([0, width]);
            
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format("d")))
                .attr("color", "#9CA3AF");

            const y = d3.scaleLinear()
                .domain([d3.min(data, d => d.price) * 0.9, d3.max(data, d => d.price) * 1.1])
                .range([height, 0]);
            
            svg.append("g")
                .call(d3.axisLeft(y).ticks(5))
                .attr("color", "#9CA3AF");

            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#10B981")
                .attr("stroke-width", 2)
                .attr("d", d3.line()
                    .x(d => x(d.year))
                    .y(d => y(d.price))
                    .curve(d3.curveMonotoneX)
                );

            const areaGradient = svg.append("defs")
                .append("linearGradient")
                .attr("id", "areaGradient")
                .attr("x1", "0%")
                .attr("y1", "0%")
                .attr("x2", "0%")
                .attr("y2", "100%");

            areaGradient.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", "#10B981")
                .attr("stop-opacity", 0.2);

            areaGradient.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", "#10B981")
                .attr("stop-opacity", 0);

            svg.append("path")
                .datum(data)
                .attr("fill", "url(#areaGradient)")
                .attr("d", d3.area()
                    .x(d => x(d.year))
                    .y0(height)
                    .y1(d => y(d.price))
                    .curve(d3.curveMonotoneX)
                );
        }

        // Fetch AI Analysis
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 6000);

        fetch(`https://text.pollinations.ai/${encodeURIComponent('Analyze ' + title + '. Provide 4 parts separated by | character: 1. A concise market analysis (2-3 sentences). 2. The origin/country. 3. Estimated price range in USD. 4. Historical price trend data for the last 5 years (2020-2024) as Year:Price pairs separated by commas. Do not use labels like "Origin:" or "Price:". Just return the values. Example format: This item is popular...|France|$500 - $1000|2020:500,2021:550,2022:600,2023:580,2024:620')}`, { signal: controller.signal })
            .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.text();
            })
            .then(text => {
                clearTimeout(timeoutId);
                const cleanText = text.split('---')[0].trim();
                let parts = cleanText.split('|').map(p => p.trim());
                
                if (parts.length < 3) {
                    parts = cleanText.split('\n').map(p => p.trim()).filter(p => p.length > 0);
                }

                let analysis = parts[0] || "Market analysis unavailable.";
                let origin = "-";
                let chartDataStr = "";

                for (let i = 1; i < parts.length; i++) {
                    const part = parts[i];
                    if (part.match(/202[0-4]\s*:\s*[\d,.]+/)) {
                        chartDataStr = part;
                    } else if (part.length < 50 && !part.includes('$')) {
                        origin = part.replace('Origin:', '').trim();
                    }
                }

                document.getElementById('ai-text').textContent = analysis;
                document.getElementById('ai-origin').textContent = origin;
                
                if (chartDataStr) {
                    const chartData = chartDataStr.split(',').map(item => {
                        const match = item.match(/(\d{4})\s*:\s*([\d.]+)/);
                        if (match) {
                            return { year: parseInt(match[1]), price: parseFloat(match[2]) };
                        }
                        return null;
                    }).filter(d => d !== null);
                    
                    if (chartData.length > 0) {
                        renderPriceChart(chartData);
                    }
                }
            })
            .catch(err => {
                clearTimeout(timeoutId);
                console.warn('AI Fetch failed, using fallback:', err);
                const base = parseInt(price) || 500;
                document.getElementById('ai-text').textContent = `Market analysis for ${title} is temporarily unavailable, but demand remains steady.`;
                document.getElementById('ai-origin').textContent = "Global";
                
                const chartData = [
                    {year: 2020, price: base * 0.8},
                    {year: 2021, price: base * 0.9},
                    {year: 2022, price: base * 1.1},
                    {year: 2023, price: base * 1.05},
                    {year: 2024, price: base * 1.2}
                ];
                renderPriceChart(chartData);
            });

        // Render Recommended Items
        const recContainer = document.getElementById('recommended-grid');
        
        async function fetchRecommendedItems() {
            recContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6B7280;"><i class="fa-solid fa-spinner fa-spin"></i> Finding related items...</div>';
            
            try {
                // AI Prompt to generate related items
                const prompt = `Generate 8 related items for a marketplace listing of "${title}". Return ONLY a pipe-separated list where each line is an item. Format: Title|Price|EstValue|Category. Price and EstValue should be numbers only (no currency symbols). Example: Vintage Lens|200|250|Photography. Do not include any other text.`;
                
                const response = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
                if (!response.ok) throw new Error('AI fetch failed');
                
                let text = await response.text();
                // Clean response (remove markdown code blocks, etc)
                text = text.replace(/```/g, '').replace(/json/g, '').trim();
                
                // Clean and parse response
                const lines = text.split('\n').filter(line => line.includes('|'));
                
                const recItems = lines.map(line => {
                    const parts = line.split('|').map(p => p.trim());
                    if (parts.length >= 2) { // Allow at least Title and Price
                        return {
                            title: parts[0],
                            price: parseInt(parts[1].replace(/[^0-9]/g, '')) || 100,
                            est: parseInt(parts[2]?.replace(/[^0-9]/g, '') || parts[1].replace(/[^0-9]/g, '')) || 120,
                            badge: parts[3] || 'Related',
                            img: '' // Placeholder used in render
                        };
                    }
                    return null;
                }).filter(item => item !== null).slice(0, 8); // Limit to 8 items

                if (recItems.length === 0) throw new Error('No valid items parsed');

                renderRecommendations(recItems);
                
            } catch (error) {
                console.warn('Recommendation fetch failed, using fallback', error);
                // Fallback items if AI fails
                const basePrice = parseInt(price) || 100;
                const baseEst = parseInt(est) || 120;
                const fallbackItems = [
                    { title: `Related Listing #1`, price: basePrice * 0.9, est: baseEst * 0.95, badge: 'Recommended' },
                    { title: `Related Listing #2`, price: basePrice * 1.1, est: baseEst * 1.15, badge: 'Recommended' },
                    { title: `Related Listing #3`, price: basePrice * 0.8, est: baseEst * 0.85, badge: 'Recommended' },
                    { title: `Related Listing #4`, price: basePrice * 1.2, est: baseEst * 1.25, badge: 'Recommended' }
                ];
                renderRecommendations(fallbackItems);
            }
        }

        function renderRecommendations(items) {
            recContainer.innerHTML = items.map(item => `
                <div class="market-card" onclick="window.location.href='listing.html?title=${encodeURIComponent(item.title)}&price=${item.price}&est=${item.est}&img='" style="cursor: pointer;">
                    <div class="card-image-container">
                        <img src="valu text.svg" alt="Placeholder" class="card-placeholder-icon">
                        <div class="card-badge"><i class="fa-solid fa-tag"></i> ${item.badge}</div>
                    </div>
                    <div class="card-content">
                        <h3 class="card-title" style="font-size: 15px;">${item.title}</h3>
                        <div class="card-stats">
                            <div class="stat-pair">
                                <span class="stat-label">Original Value</span>
                                <span class="stat-val" style="color: #9CA3AF; font-weight: 500;">$${Math.floor(item.price).toLocaleString()}</span>
                            </div>
                            <div class="stat-pair" style="text-align: right;">
                                <span class="stat-label">Est. Value</span>
                                <span class="stat-val" style="font-size: 24px; color: #111827; line-height: 1.1; font-weight: 700;">$${Math.floor(item.est).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Start fetch
        fetchRecommendedItems();

        // Like Button Logic
        const likeBtn = document.getElementById('listing-like-btn');
        const likedItems = JSON.parse(localStorage.getItem('likedItems') || '[]');
        
        if (likedItems.includes(title)) {
            likeBtn.classList.add('active');
        }
        
        likeBtn.addEventListener('click', () => {
            const currentLiked = JSON.parse(localStorage.getItem('likedItems') || '[]');
            const index = currentLiked.indexOf(title);
            
            if (index === -1) {
                currentLiked.push(title);
                likeBtn.classList.add('active');
            } else {
                currentLiked.splice(index, 1);
                likeBtn.classList.remove('active');
            }
            
            localStorage.setItem('likedItems', JSON.stringify(currentLiked));
        });
    </script>
    <nav class="bottom-nav">
        <a href="marketplace.html" class="bottom-nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-grid-icon lucide-layout-grid"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
            <span>My Feed</span>
        </a>
        <a href="index.html" class="bottom-nav-item">
            <i class="fa-regular fa-user"></i>
            <span>My Value</span>
        </a>
        <a href="#" class="bottom-nav-item">
            <i class="fa-regular fa-circle-user" style="font-size: 24px;"></i>
            <span>Settings</span>
        </a>
        <div class="bottom-nav-post-container">
            <a href="post.html" class="bottom-nav-post">
                <i class="fa-solid fa-plus"></i>
            </a>
        </div>
    </nav>
</body>
</html>